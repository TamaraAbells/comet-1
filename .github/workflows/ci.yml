name: "Build & Deploy"

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    tags:
      - "v*.*.*"

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "frontend", "context": "./frontend", "file": "./Dockerfile.prod" }'

  api:
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "api", "context": "./api", "file": "./Dockerfile.prod" }'

  imageflow:
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "imageflow", "context": "./imageflow", "file": "./imageflow/Dockerfile" }'

  iframely-base:
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "iframely-base", "context": "https://github.com/itteco/iframely.git", "file": "Dockerfile" }'

  iframely:
    needs: [iframely-base]
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "iframely", "context": "./iframely", "file": "./iframely/Dockerfile" }'

  nginx:
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Build
          token: ${{ secrets.PAT }}
          inputs: '{ "image": "nginx", "context": "./nginx", "file": "./nginx/Dockerfile", "build-args": "CERT=\"${{ secrets.SSL_CERT }}\" KEY=\"${{ secrets.SSL_KEY }}\"" }'

  deploy:
    needs: [frontend, api, imageflow, iframely-base, iframely, nginx]
    runs-on: ubuntu-latest
    steps:
      - uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Deploy
          token: ${{ secrets.PAT }}
